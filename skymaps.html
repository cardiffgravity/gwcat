<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
	<title>GW Localisation Skymaps</title>
    <link rel="icon" type="image/vnd.microsoft.icon" href="img/favicon-32x32.png" />
	<!--<script type="text/javascript" src="js/lib/d3.v4.min.js"></script>-->
	<!-- <script type="text/javascript" src="js/lib/stuquery.js"></script> -->
	<script type="text/javascript" src="js/gwcat.js"></script>
    <script type="text/javascript" src="js/lib/d3.v4.min.js"></script>
	<style>
    div.image-list{
        border:1px solid black;
        text-align:center;
    }
    div.image{
        margin:10px;
        border:1px solid #555555;
        display:inline-block;
        text-align:center;
    }
    div.image img{
        width:250px;
    }
    div.image.cartzoom img{
        width:125px;
    }
    div.image h3{
        width:100%;
    }
	</style>
</head>
<body>
	<h1>Sky localisation maps</h1>
    <p>Based on the <b><a href="http://gwcat.cardiffgravity.org">gwcat</a></b> database, compiled from data at the <a href="https://www.gw-openscience.org/">Gravitational Wave Open Science Centre</a> and <a href="https://gracedb.ligo.org/latest/">GraceDB</a>.</p>
    <p>Latest build:
        <ul>
            <li><b><a id='gwosc-build-url' href="">Gwosc Catalogue</a>: </b><span id='gwosc-build-date'></span></li>
            <li><b><a id='gracedb-build-url'href="">GraceDB</a>: </b><span id='gracedb-build-date'></span></li>
            <li><b><a id='manual-build-url'href="">Manual Import</a>: </b><span id='manual-build-date'></span></li>
        </ul>
    </p>
	<div id='image-holder'></div>

	<script type="text/javascript">
		function populateImages(){
            gwcat.orderData('GPS',reverse=true)
            if ((gwcat.meta)&&(gwcat.meta.gwosc)){
                document.getElementById('gwosc-build-date').innerHTML = gwcat.meta.gwosc.retrieved
                document.getElementById('gwosc-build-url').setAttribute('href',gwcat.meta.gwosc.src)
            }
            if ((gwcat.meta)&&(gwcat.meta.graceDB)){
                document.getElementById('gracedb-build-date').innerHTML = gwcat.meta.graceDB.retrieved
                document.getElementById('gracedb-build-url').setAttribute('href',gwcat.meta.graceDB.src)
            }
            if ((gwcat.meta)&&(gwcat.meta.manual)){
                document.getElementById('manual-build-date').innerHTML = gwcat.meta.manual.retrieved
                document.getElementById('manual-build-url').setAttribute('href',gwcat.meta.manual.src)
            }
            for (e in gwcat.data){
                event=gwcat.data[e];
                ev=event.name;
                imMoll=gwcat.getLink(ev,ltype='skymap-plot',ltxt='\(Mollweide fullsky\)')[0];
                imCart=gwcat.getLink(ev,ltype='skymap-plot',ltxt='\(Cartesian fullsky\)')[0];
                imCartzoom=gwcat.getLink(ev,ltype='skymap-plot',ltxt='\(Cartesian zoomed\)')[0];
                imMollrot=gwcat.getLink(ev,ltype='skymap-plot',ltxt='\(Mollweide fullsky, rotated\)')[0];
                imCartrot=gwcat.getLink(ev,ltype='skymap-plot',ltxt='\(Cartesian fullsky, rotated\)')[0];
                imPlain=gwcat.getLink(ev,ltype='skymap-plain',ltxt='\(no annotations\)')[0];
                thumbMoll=gwcat.getLink(ev,ltype='skymap-thumb',ltxt='\(Mollweide fullsky\)')[0];
                thumbCart=gwcat.getLink(ev,ltype='skymap-thumb',ltxt='\(Cartesian fullsky\)')[0];
                thumbCartzoom=gwcat.getLink(ev,ltype='skymap-thumb',ltxt='\(Cartesian zoomed\)')[0];
                thumbMollrot=gwcat.getLink(ev,ltype='skymap-thumb',ltxt='\(Mollweide fullsky, rotated\)')[0];
                thumbCartrot=gwcat.getLink(ev,ltype='skymap-thumb',ltxt='\(Cartesian fullsky, rotated\)')[0];

                divIm=document.createElement('div');
                divIm.setAttribute('class','image-list '+ev);

                // get links
                datalink=gwcat.getOpenData(ev).url;
                if (datalink.search('gracedb')>=0){
                    weblink=datalink.replace('/api','');
                    morelink='http://chirp.sr.bham.ac.uk/alert/'+ev;
                }else{
                    weblink=datalink;
                    morelink='';
                }
                maplink=gwcat.getMeta(ev,'mapurlsrc');
                html='<h2>'+'<a href="'+weblink+'">'+ev+'</a></h2>';
                uptime=gwcat.getMeta(ev,'mapdatesrc');
                uptime=uptime.replace(/\..*/,' UTC').replace('T',' ');
                html+='<p><a href="'+maplink+'">Map</a> updated: '+uptime;
                html+=' ; 90% area='+gwcat.getBest(ev,'deltaOmega')+'deg<sup>2</sup>';
                html+='</br>';

                // console.log(ev,gwcat.getBest(ev,'FAR'),gwcat.getValue(ev,'FAR','fartype'));
                farval=(1/gwcat.getBest(ev,'FAR')).toPrecision(2).replace('e','x10^');
                reSup=/\^(-?[+\-0-9]*)(?=[\s/]|$)/g
                farval=farval.replace(reSup,"<sup>$1</sup> ");
                farun=gwcat.paramUnit('FAR').replace(reSup,"<sup>$1</sup> ")
                html+='FAR='+farval+' '+farun;
                html+='('+gwcat.getValue(ev,'FAR','fartype')+')';

                mostlikely=gwcat.getBest(ev,'objType');
                html+=' ; Most likely source: '+mostlikely;
                if((gwcat.data[e].objType)&&(gwcat.data[e].objType.prob)){
                    if ('Terrestrial' in gwcat.data[e].objType.prob){
                        if (gwcat.data[e].objType.prob.Terrestrial>0){
                            pterr=(100*gwcat.data[e].objType.prob.Terrestrial).toFixed(0);
                            pterr = (pterr < 1) ? '<1' : pterr;
                        }else{pterr=0}
                    }else{pterr=0}
                    html+=' ; Prob(Terrestrial): '+pterr+'%';
                }
                if (morelink!=''){
                    html+=' ; <a href="'+morelink+'">More...</a>'
                }
                html+='</p>';

                divIm.innerHTML = html;

                if (imMoll){
                    divMoll=document.createElement('div');
                    divMoll.setAttribute('class','image moll '+ev);
                    divMoll.innerHTML = '<a href="'+imMoll.url+'"><img src="'+thumbMoll.url+'"></a><h3>'+imMoll.text+'</h3>';
                    divIm.appendChild(divMoll);
                }
                if (imCart){
                    divCart=document.createElement('div');
                    divCart.setAttribute('class','image cart '+ev);
                    divCart.innerHTML = '<a href="'+imCart.url+'"><img src="'+thumbCart.url+'"></a><h3>'+imCart.text+'</h3>';
                    divIm.appendChild(divCart);
                }
                if (imMollrot){
                    divMollrot=document.createElement('div');
                    divMollrot.setAttribute('class','image moll-rot '+ev);
                    divMollrot.innerHTML = '<a href="'+imMollrot.url+'"><img src="'+thumbMollrot.url+'"></a><h3>'+imMollrot.text+'</h3>';
                    divIm.appendChild(divMollrot);
                }
                if (imCartrot){
                    divCartrot=document.createElement('div');
                    divCartrot.setAttribute('class','image cart-rot '+ev);
                    divCartrot.innerHTML = '<a href="'+imCartrot.url+'"><img src="'+thumbCartrot.url+'"></a><h3>'+imCartrot.text+'</h3>';
                    divIm.appendChild(divCartrot);
                }
                if (imCartzoom){
                    divCartzoom=document.createElement('div');
                    divCartzoom.setAttribute('class','image cartzoom '+ev);
                    divCartzoom.innerHTML = '<a href="'+imCartzoom.url+'"><img src="'+thumbCartzoom.url+'"></a><h3>'+imCartzoom.text+'</h3>';
                    divIm.appendChild(divCartzoom);
                }
                divIm.innerHTML += '<p><a href='+imPlain.url+'>Plain, unnannotated skymap</a> (J2000, Cartesian, greyscale, 8192x4096)</p>';
                document.getElementById('image-holder').appendChild(divIm)
            }
		}
		// var gwcat = new GWCat(runTests,{fileIn:'data/gwosc_gracedb.json',confirmedOnly:true});
        // var gwcat = new GWCat(populateImages,{confirmedOnly:true,fileIn:'data/gwosc_gracedb.json',loadMethod:'json'});
        var gwcat = new GWCat(populateImages,{confirmedOnly:false,debug:true});
	</script>
</body>
</html>